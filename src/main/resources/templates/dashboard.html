<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Zentask - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #fdfaf6; font-family: 'Inter', sans-serif; }
        .task-card { border: none; border-radius: 1.5rem; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.02); transition: all 0.3s; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.05); }
        .badge-TODO { background: #f5f5f4; color: #78716c; }
        .badge-IN_PROGRESS { background: #fef3c7; color: #b45309; }
        .badge-DONE { background: #dcfce7; color: #166534; }
        .btn-primary { background-color: #064e3b; border: none; }
        .nav-link { color: #78716c; font-weight: 500; }
        .nav-link.active { color: #064e3b; font-weight: 800; }
    </style>
</head>
<body>
<div class="container py-5" style="max-width: 900px;">
    <header class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-black text-dark tracking-tight">Peace.</h1>
            <p class="text-muted">Here is your day.</p>
        </div>
        <div class="d-flex gap-3">
            <button class="btn btn-primary px-4 rounded-pill fw-bold" data-bs-toggle="modal" data-bs-target="#taskModal">New Intention</button>
            <a href="/login" class="btn btn-light rounded-pill px-4 fw-bold">Logout</a>
        </div>
    </header>

    <div class="row g-4" id="taskContainer">
        <!-- Tasks -->
    </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-5 p-4">
            <div class="modal-body">
                <h4 class="fw-black mb-4">Record Intention</h4>
                <form id="taskForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">What is your focus?</label>
                        <input type="text" id="title" class="form-control rounded-3" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Details</label>
                        <textarea id="description" class="form-control rounded-3" rows="3"></textarea>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted">Priority</label>
                            <select id="priority" class="form-select rounded-3">
                                <option value="LOW">Subtle</option>
                                <option value="MEDIUM" selected>Balanced</option>
                                <option value="HIGH">Urgent</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted">Status</label>
                            <select id="status" class="form-select rounded-3">
                                <option value="TODO">Focus</option>
                                <option value="IN_PROGRESS">Flow</option>
                                <option value="DONE">Calm</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Commit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    async function fetchTasks() {
        const res = await fetch('/api/tasks');
        if (!res.ok) return window.location.href = '/login';
        const tasks = await res.json();
        const container = document.getElementById('taskContainer');
        container.innerHTML = tasks.length ? tasks.map(t => `
            <div class="col-12">
                <div class="task-card p-4 d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge badge-${t.status} rounded-pill px-3 py-1 small mb-2 d-inline-block">${t.status}</span>
                        <h5 class="fw-bold mb-1">${t.title}</h5>
                        <p class="text-muted small mb-0">${t.description || ''}</p>
                    </div>
                    <div class="text-end">
                        <span class="text-muted small d-block mb-2 fw-bold">${t.priority}</span>
                        <button class="btn btn-sm text-danger fw-bold" onclick="deleteTask(${t.id})">Remove</button>
                    </div>
                </div>
            </div>
        `).join('') : '<div class="text-center py-5"><p class="text-muted">No intentions recorded yet.</p></div>';
    }

    document.getElementById('taskForm').onsubmit = async (e) => {
        e.preventDefault();
        const task = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            status: document.getElementById('status').value,
            priority: document.getElementById('priority').value
        };
        const res = await fetch('/api/tasks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(task)
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            document.getElementById('taskForm').reset();
            fetchTasks();
        }
    };

    async function deleteTask(id) {
        if(confirm('Release this intention?')) {
            await fetch('/api/tasks/' + id, { method: 'DELETE' });
            fetchTasks();
        }
    }

    fetchTasks();
</script>
</body>
</html>